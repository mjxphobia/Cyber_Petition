<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>입구 퍼즐 → 저승 신문고</title>
<style>
  :root{
    --fg:#111; --bg:#fff; --sub:#555; --acc:#0ea5e9; --card:#fff; --border:#e5e7eb;
    --bar-bg:#f1f5f9; --bar-fill:#10b981;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans KR",sans-serif;}
  .wrap{max-width:900px;margin:0 auto;padding:20px;}
  .center{text-align:center}
  .title{font-size:28px;font-weight:900;margin:6px 0 18px;letter-spacing:.3px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:18px}
  .spacer{height:12px}
  [hidden]{display:none!important}

  /* ─── 퍼즐(북) 페이지 ─── */
  .gate-wrap{width:min(92vw,560px); margin:24px auto;}
  .drum{
    position:relative; width:100%; aspect-ratio:1/1;
    border-radius:14px; overflow:hidden;
    box-shadow:0 18px 36px rgba(0,0,0,.35); background:#222;
  }
  .drum img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
  .grid{position:absolute; inset:0; display:grid; grid-template-columns:repeat(4,1fr); grid-template-rows:repeat(4,1fr);}
  .cell{
    background:transparent; border:none; padding:0; margin:0; cursor:pointer;
    -webkit-tap-highlight-color:transparent; outline:none; /* 클릭 테두리 제거 */
  }
  .gate-title{font-weight:900; font-size:20px; margin:8px 0 10px; text-align:center;}
  .gate-caption{color:#555; margin:10px 0 0; font-size:14px; text-align:center;}

  .hud{display:flex; gap:6px; justify-content:center; margin-top:12px;}
  /* 진행 표시 ‘점’ 대신 봉(stick.png) */
  .dot{
    width:36px; height:36px;
    display:inline-block; margin:0 6px;
    background:#c7c7c7; border-radius:50%;
    transition:background .2s, transform .2s;
  }
  .dot.on{
    background:url("static/stick.png") no-repeat center center / contain;
    border-radius:0; background-color:transparent; transform:scale(1.05);
  }

  /* ─── 신문고 기본 스타일 ─── */
  .list{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;flex-direction:column;gap:10px;border:1px solid var(--border);border-radius:12px;padding:14px}
  .row h3{margin:0 0 6px;font-size:18px}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .gauge{flex:1;height:12px;background:var(--bar-bg);border-radius:999px;overflow:hidden}
  .gauge>span{display:block;height:100%;background:var(--bar-fill)}
  .pct{min-width:52px;text-align:right;font-weight:800}
  .btn{
    display:inline-block;padding:12px 18px;border-radius:12px;border:1px solid #000;text-decoration:none;cursor:pointer;
    background:#111;color:#fff;font-weight:800;transition:.15s;
  }
  .btn.alt{background:#fff;color:#111;border-color:#111}
  .btn.ghost{background:transparent;color:#111;border-color:var(--border)}
  .btn:hover{filter:brightness(1.02);transform:translateY(-1px)}
  .post-title{font-size:22px;font-weight:900;margin:0 0 8px}
  .post-body{color:#333;line-height:1.7;margin:0}
  .field{display:flex;flex-direction:column;gap:8px;margin:10px 0}
  .label{font-weight:800}
  input[type="text"]{border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-size:16px;outline:none;background:#fff;}
  .template{line-height:1.9;border:1px dashed var(--border);border-radius:12px;padding:14px;background:#fcfcfc;}
  .blank{display:inline-block; padding:2px 6px; margin:0 2px; border-bottom:2px solid #111; cursor:pointer; background:#fff; border-radius:6px; min-width:2.8em; text-align:center;}
  .blank.placeholder{ color:#9aa0a6; font-style:italic; border-bottom-color:#b9c0c7; }
  .blank.filled{ background:#e8f7ff; border-bottom-color:#0ea5e9; color:#111; font-style:normal; }
  .xlbox{position:absolute; z-index:9999; background:#fff; border:1px solid #b6b6b6; border-radius:6px; box-shadow:0 6px 16px rgba(0,0,0,.15); min-width:140px; max-width:240px; overflow:hidden;}
  .xl-item{padding:8px 10px; font-size:14px; cursor:pointer; white-space:nowrap;}
  .xl-item:hover{ background:#e8f0fe; }
  .toast{position:fixed; left:50%; top:24px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:10px;
         box-shadow:0 6px 16px rgba(0,0,0,.2); opacity:0; pointer-events:none; transition:.25s ease;}
  .toast.show{opacity:1}
  @media (max-width:520px){ .title{font-size:24px} }

  /* 퍼즐 아래에 잠깐 뜨는 리셋 안내 */
  .gate-msg{
    text-align:center; color:#b00020; font-weight:800;
    min-height:1.2em; opacity:0; transition:.2s;
  }
  .gate-msg.show{ opacity:1; }
</style>
</head>
<body>

  <!-- ───────── 첫 화면: 북 퍼즐 ───────── -->
  <section id="page-gate" class="wrap">
    <div class="gate-title">문을 열려면 올바른 순서로 북을 두드리세요</div>
    <div class="gate-wrap">
      <div class="drum" id="drum">
        <img id="drumImg" src="static/drum.png" alt="북 퍼즐 이미지">
        <div class="grid" id="grid"></div>
      </div>
      <div class="hud" id="hud"></div>
      <p id="gate-msg" class="gate-msg"></p>
      <p class="gate-caption"> *신문고는 한국 조선 시대에 <br> 억울한 백성이 왕에게 직접 <br> 호소하기 위해 설치된 제도입니다. </p>
    </div>
  </section>

  <!-- ───────── 두 번째: 저승 신문고 ───────── -->
  <main id="app" class="wrap" hidden>
    <section id="page-home" class="card">
      <h1 class="title center">저승 신문고</h1>
      <div id="post-list" class="list"></div>
      <div class="spacer"></div>
      <div class="center"><button class="btn" id="create-btn">신규 작성하기</button></div>
    </section>

    <section id="page-detail" class="card" hidden>
      <h2 id="detail-title" class="post-title"></h2>
      <p id="detail-body" class="post-body"></p>
      <div class="spacer"></div>
      <div class="center" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <button class="btn alt" id="vote-btn">투표하기</button>
        <button class="btn ghost" id="back-home-1">뒤로가기</button>
      </div>
    </section>

    <section id="page-new" class="card" hidden>
      <h2 class="title center" style="margin-bottom:6px;">새 청원 작성</h2>

      <div class="field">
        <label class="label" for="title-input">제목</label>
        <input id="title-input" type="text" placeholder="제목을 입력해주세요." />
      </div>

      <div class="field">
        <div class="label">청원문</div>
        <div id="template" class="template">
          존경하는 <span class="blank placeholder" data-key="target">선택</span>,
          <span class="blank placeholder" data-key="place">선택</span>의 모든 메뉴에
          <span class="blank placeholder" data-key="ingredient">선택</span>가 들어가 국민들이 힘들어하고 있습니다.
          <span class="blank placeholder" data-key="proposal">선택</span>로 음식을 만들게 해주세요.
        </div>
      </div>

      <div class="spacer"></div>
      <div class="center" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <button class="btn" id="submit" hidden>제출하기</button>
        <button class="btn ghost" id="back-home-2">뒤로가기</button>
      </div>
    </section>

    <section id="page-done" class="card center" hidden>
      <h2 class="title" style="margin-bottom:4px;">접수 안내</h2>
      <div id="typeout" class="type mono"></div>
      <div class="spacer"></div>
      <button class="btn" id="to-reply" hidden>염라대왕님의 답변이 도착했습니다</button>
    </section>

    <section id="page-reply" class="card center" hidden>
      <h2 class="title" style="margin-bottom:6px;">답변</h2>
      <div class="mono" style="font-size:22px; font-weight:900; letter-spacing:.2em;">ONE DAY WAIT</div>
      <div class="spacer"></div>
      <button class="btn ghost" id="back-home-3">처음으로</button>
    </section>
  </main>

  <div id="toast" class="toast">소중한 한표 감사합니다</div>

<script>
/* ───────────────── 퍼즐(북) 로직 ───────────────── */
/* 단계: OR 집합 (요청안 반영) */
// ✅ 고정 정답
const SEQ = [
  ["2","4"],                               // step 1
  ["1","3"],                               // step 2
  ["1","2"],                               // step 3
  ["1","2"],                               // step 4
  ["4","3"],                               // step 5
  [ ["2","2"], ["2","3"], ["3","2"], ["3","3"] ]  // step 6: 네 칸 중 아무거나
];

/* 진행 HUD(봉 6개) */
const hud = document.getElementById('hud');
hud.innerHTML = SEQ.map((_,i)=>`<span class="dot" id="d${i}"></span>`).join('');
function paintProgress(n){
  for(let i=0;i<SEQ.length;i++){
    document.getElementById(`d${i}`).classList.toggle('on', i < n);
  }
}

/* 초기 상태 */
let progress = 0;
let inputLocked = false;
paintProgress(progress);

/* 4x4 클릭 버튼 생성 */
const grid = document.getElementById('grid');
for(let y=1; y<=4; y++){
  for(let x=1; x<=4; x++){
    const b = document.createElement('button');
    b.className = 'cell'; b.type='button';
    b.dataset.xy = `${x},${y}`;
    b.addEventListener('pointerdown', onHit, {passive:true});
    grid.appendChild(b);
  }
}

/* 좌표 판정 (마지막 스텝은 여러 칸 중 하나 허용) */
function isAllowed(step, x, y){
  const target = SEQ[step];
  if (!target) return false;
  if (Array.isArray(target[0])){
    return target.some(([ax,ay]) => ax===x && ay===y);
  }
  const [tx,ty] = target;
  return tx===x && ty===y;
}

/* 오답 시 완전 리셋 + 안내 */
function resetPuzzle(){
  progress = 0;
  paintProgress(0);
  const msg = document.getElementById('gate-msg');
  if (msg){
    msg.textContent = "틀렸습니다. 처음부터 다시!";
    msg.classList.add('show');
    setTimeout(()=> msg.classList.remove('show'), 900);
  }
}

/* 흔들림 애니메이션(테두리 X) */
function shake(){
  const el = document.getElementById('drum');
  el.animate(
    [{transform:"translateX(0)"},{transform:"translateX(-10px)"},{transform:"translateX(10px)"},{transform:"translateX(0)"}],
    {duration:220, easing:"ease-in-out"}
  );
}

/* 클릭 처리: 항상 흔들리게 */
function onHit(e){
  if (inputLocked) return;

  // ✅ 무조건 흔들기 (정답/오답 상관없이)
  shake();

  const [x, y] = (e.currentTarget.dataset.xy || "").split(",");

  if (isAllowed(progress, x, y)) {
    // 정답 처리
    progress++;
    paintProgress(progress);

    // 마지막 단계 도달 시, 흔들기 애니메이션 끝난 뒤 화면 전환
    if (progress === SEQ.length) {
      inputLocked = true;
      setTimeout(() => {
        document.getElementById('page-gate').hidden = true;
        startSinmungo();
        inputLocked = false;
      }, 240); // shake() duration(220ms)보다 살짝 길게
    }
  } else {
    // 오답 처리 (리셋)
    inputLocked = true;
    resetPuzzle();
    setTimeout(() => { inputLocked = false; }, 300);
  }
}


/* ───────────────── 저승 신문고(앱) 로직 ───────────────── */
function startSinmungo(){
  document.getElementById('app').hidden = false;

  const posts = [
    { id:1, title:"복권방 주인 비리의혹으로 인한 검찰수사를 요청드립니다",
      body:`존경하는 관계부처 담당자께.

최근 저승 복권방에서의 부정 행위에 대한 신고가 다수 접수되었습니다.
공정한 절차와 신뢰 회복을 위해 철저한 수사가 필요합니다.
저승 시민의 알 권리와 공정한 거래 질서를 위해 신속한 조치를 요청드립니다.

감사합니다.`, percent:72 },
    { id:2, title:"솔로지옥 2회 개최부탁드립니다",
      body:`안녕하십니까.

저승 문화 진흥을 위해 솔로지옥 2회 개최를 공식 제안합니다.
참여 수요가 충분하고, 저승 관광 및 경제 활성화에 긍정적 효과가 기대됩니다.
공정한 선발, 안전 관리, 윤리 기준을 갖춘 운영 계획 수립을 요청드립니다.

감사합니다.`, percent:41 },
    { id:3, title:"저승창립기념일 공휴일로 지정해주세요",
      body:`안전하고 지속 가능한 저승 사회를 기념하기 위해
저승창립기념일을 공식 공휴일로 지정해 주시길 청원합니다.
휴식과 공동체 결속을 강화해 생산성과 만족도를 높이는 데 기여할 것입니다.

검토 부탁드립니다.`, percent:89 },
  ];

  const pageHome  = document.getElementById('page-home');
  const pageDetail= document.getElementById('page-detail');
  const pageNew   = document.getElementById('page-new');
  const pageDone  = document.getElementById('page-done');
  const pageReply = document.getElementById('page-reply');
  const listEl    = document.getElementById('post-list');
  const dTitle    = document.getElementById('detail-title');
  const dBody     = document.getElementById('detail-body');
  const createBtn = document.getElementById('create-btn');
  const back1     = document.getElementById('back-home-1');
  const back2     = document.getElementById('back-home-2');
  const back3     = document.getElementById('back-home-3');
  const submitBtn = document.getElementById('submit');
  const typeout   = document.getElementById('typeout');
  const toReply   = document.getElementById('to-reply');
  const titleInput= document.getElementById('title-input');
  const toast     = document.getElementById('toast');
  const templateEl= document.getElementById('template');

  function renderList(){
    listEl.innerHTML = posts.map(p => `
      <article class="row">
        <h3>${p.title}</h3>
        <div class="meta">
          <div class="gauge" aria-label="참여율 ${p.percent}%"><span style="width:${p.percent}%"></span></div>
          <div class="pct">${p.percent}%</div>
        </div>
        <div class="center" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button class="btn alt" onclick="openDetail(${p.id})">자세히 보기</button>
        </div>
      </article>
    `).join('');
  }

  function show(section){
    [pageHome,pageDetail,pageNew,pageDone,pageReply].forEach(s=>s.hidden=true);
    section.hidden = false;
    window.scrollTo({top:0,behavior:'instant'});
  }

  window.openDetail = function(id){
    const p = posts.find(x=>x.id===id);
    if(!p) return;
    dTitle.textContent = p.title;
    dBody.textContent  = p.body;
    show(pageDetail);
  }

  function showToast(msg="소중한 한표 감사합니다"){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 1500);
  }
  document.getElementById('vote-btn').addEventListener('click', ()=> showToast());

  const correctMap = { target:"염라대왕님", place:"구내식당", ingredient:"치즈", proposal:"다양한 재료" };
  const optionsMap = {
    target:["염라대왕님","저승차사님","삼도천관리국장님"],
    place:["구내식당","경비실","민원실"],
    ingredient:["치즈","민트초코","마라소스"],
    proposal:["다양한 재료","단일 재료","무염 식단"]
  };
  function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }

  let dropdown=null;
  templateEl.addEventListener('click', (e)=>{
    const span=e.target.closest('.blank'); if(!span) return;
    closeDropdown();
    const key=span.dataset.key;
    const opts=shuffle(optionsMap[key]||[]);
    dropdown=document.createElement('div');
    dropdown.className='xlbox';
    dropdown.innerHTML = opts.map(v=>`<div class="xl-item" data-val="${v}">${v}</div>`).join('');
    const rect=span.getBoundingClientRect();
    dropdown.style.left=`${rect.left+window.scrollX}px`;
    dropdown.style.top =`${rect.bottom+window.scrollY+4}px`;
    document.body.appendChild(dropdown);
    dropdown.addEventListener('click', (ev)=>{
      const it=ev.target.closest('.xl-item'); if(!it) return;
      span.textContent=it.dataset.val;
      span.classList.add('filled'); span.classList.remove('placeholder');
      closeDropdown(); checkAllReady();
    });
    document.addEventListener('mousedown', outsideClose, {capture:true, once:true});
  });
  function outsideClose(ev){ if(dropdown && !dropdown.contains(ev.target)) closeDropdown(); }
  function closeDropdown(){ if(dropdown){ dropdown.remove(); dropdown=null; } }

  function checkAllReady(){
    const titleOk=!!titleInput.value.trim();
    const spans=templateEl.querySelectorAll('.blank');
    let allCorrect=true;
    spans.forEach(s=>{
      const key=s.dataset.key;
      const val=s.textContent.trim();
      if(val!==correctMap[key]) allCorrect=false;
    });
    submitBtn.hidden = !(titleOk && allCorrect);
  }
  titleInput.addEventListener('input', checkAllReady);

  submitBtn.addEventListener('click', ()=>{
    show(pageDone); typeout.textContent=""; toReply.hidden=true;
    const text="제출이 완료되었습니다.";
    let i=0; const timer=setInterval(()=>{
      typeout.textContent += text[i++]; 
      if(i>=text.length){ clearInterval(timer); setTimeout(()=>{ toReply.hidden=false; }, 500); }
    },80);
  });
  toReply.addEventListener('click', ()=> show(pageReply));

  document.getElementById('back-home-1').addEventListener('click', ()=> show(pageHome));
  document.getElementById('back-home-2').addEventListener('click', ()=> show(pageHome));
  document.getElementById('back-home-3').addEventListener('click', ()=> show(pageHome));
  document.getElementById('create-btn').addEventListener('click', ()=> show(pageNew));

  renderList();
  show(pageHome);
}
</script>
</body>
</html>
